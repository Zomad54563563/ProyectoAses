<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Profesor</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .chat-container { width:100%; margin:20px auto; display:flex; gap:16px; height:calc(100vh - 100px); }
        .students-panel { width:220px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; }
        .students-panel h3 { margin:12px; font-size:16px; color:#333; }
        #students-list { flex:1; overflow-y:auto; padding:8px; }
        .student-item { padding:12px; border-bottom:1px solid #eee; cursor:pointer; transition:0.2s; user-select:none; }
        .student-item:hover { background:#f0f4f8; }
        .student-item.active { background:#e3f2fd; border-left:4px solid #2196F3; }
        .student-item strong { display:block; color:#333; font-weight:600; }
        .student-item small { color:#999; font-size:12px; }
        
        .chat-panel { flex:1; display:flex; flex-direction:column; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); overflow:hidden; }
        .chat-header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border-bottom:none; }
        .chat-header h2 { margin:0; font-size:18px; }
        .chat-header small { opacity:0.9; font-size:13px; }
        
        .messages { flex:1; overflow-y:auto; padding:16px; background:#f8f9fa; display:flex; flex-direction:column; gap:8px; }
        .message-group { display:flex; gap:8px; margin-bottom:8px; }
        .message-group.me { justify-content:flex-end; }
        .message-group.them { justify-content:flex-start; }
        .message-bubble { max-width:80%; padding:12px 14px; border-radius:12px; word-wrap:break-word; }
        .message-group.me .message-bubble { background:#4CAF50; color:#fff; }
        .message-group.them .message-bubble { background:#fff; color:#222; border:1px solid #ddd; }
        .message-time { font-size:11px; opacity:0.7; margin-top:4px; }
        
        .chat-input-box { display:flex; gap:8px; padding:14px; background:#fff; border-top:1px solid #eee; }
        .chat-input-box input { flex:1; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:14px; }
        .chat-input-box button { padding:10px 18px; background:#2196F3; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; transition:0.2s; }
        .chat-input-box button:hover { background:#1976D2; }
    </style>
</head>
<body>
    <header style="display:flex; justify-content:flex-end; gap:8px; padding:12px;">
        <button onclick="regresarPanelProfesor()" class="btn-azul">Volver al Panel</button>
    </header>
    <div class="chat-container">
        <div class="students-panel">
            <h3>ðŸ“š Alumnos</h3>
            <div id="students-list">
                <p style="color:#666; text-align:center; padding:20px 12px;">Cargando alumnos...</p>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                <div>
                    <h2 id="chat-with">Selecciona un alumno</h2>
                    <small id="prof-info">Cargando informaciÃ³n...</small>
                </div>
            </div>

            <div id="messages" class="messages">
                <p style="color:#999; text-align:center; margin:auto;">Seleccione un alumno para iniciar el chat</p>
            </div>

            <div class="chat-input-box">
                <input id="msg-input" placeholder="Escribe un mensaje y presiona Enter..." disabled>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const profesorId = localStorage.getItem('profesor_id') || '';
    document.getElementById('prof-info').textContent = profesorId ? `Profesor ID: ${profesorId}` : 'Profesor no identificado en localStorage';

    // Cargar lista de alumnos
    fetch('/api/profesor/alumnos').then(r=>r.json()).then(data=>{
        const list = document.getElementById('students-list');
        const alumnos = data.alumnos || [];
        if (!alumnos.length) { list.innerHTML = '<p style="color:#666; text-align:center; padding:20px">No hay alumnos.</p>'; return; }
        list.innerHTML = alumnos.map(a => `<div class="student-item" data-id="${a.id}"><strong>${escapeHtml(a.nombre||a.correo||'Alumno')}</strong><small>ID: ${a.id}</small></div>`).join('');
        list.querySelectorAll('.student-item').forEach(el=>el.addEventListener('click', ()=>{
            document.querySelectorAll('.student-item').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            startConversation(el.getAttribute('data-id'));
        }));
    }).catch(()=>{ document.getElementById('students-list').innerHTML = '<p style="color:#666; text-align:center; padding:20px">Error cargando alumnos.</p>'; });

    document.getElementById('msg-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
});

let pollInterval = null;
let currentAlumno = null;

function startConversation(alumnoId) {
    currentAlumno = alumnoId;
    document.getElementById('msg-input').disabled = false;
    loadMessages();
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(loadMessages, 3000);
    document.getElementById('chat-with').textContent = `ðŸ’¬ Alumno ID ${alumnoId}`;
}

async function loadMessages() {
    const profesorId = localStorage.getItem('profesor_id') || '';
    if (!currentAlumno || !profesorId) return;
    const container = document.getElementById('messages');
    try {
        const res = await fetch(`/api/chat/conversation?alumno_id=${encodeURIComponent(currentAlumno)}&profesor_id=${encodeURIComponent(profesorId)}`);
        if (!res.ok) throw new Error('error');
        const data = await res.json();
        const mensajes = data.mensajes || [];
        
        if (!mensajes.length) { container.innerHTML = '<p style="color:#999; text-align:center; margin:auto;">Sin mensajes aÃºn</p>'; return; }
        
        container.innerHTML = mensajes.map(m => {
            const tiempo = new Date(m.fecha || m.created_at || Date.now()).toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});
            return `<div class="message-group ${m.from==='profesor'?'me':'them'}"><div><div class="message-bubble">${escapeHtml(m.text || m.mensaje)}</div><div class="message-time">${tiempo}</div></div></div>`;
        }).join('');
        container.scrollTop = container.scrollHeight;
    } catch (e) {
        // silencioso
    }
}

function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>\"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

async function sendMessage() {
    const profesorId = localStorage.getItem('profesor_id') || '';
    const alumnoId = currentAlumno;
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text) return;
    if (!profesorId || !alumnoId) return alert('AsegÃºrese de cargar una conversaciÃ³n.');

    try {
        await fetch('/api/chat/send', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({from:'profesor', profesor_id:profesorId, alumno_id:alumnoId, mensaje:text})
        });
        input.value = '';
        loadMessages();
    } catch (e) {
        alert('No se pudo enviar el mensaje.');
    }
}

function regresarPanelProfesor() {
    window.location.href = 'panelprofesor.html';
}
</script>
</body>
</html>
